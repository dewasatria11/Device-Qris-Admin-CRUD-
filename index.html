<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Soundbox QRIS - Store Admin</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; max-width: 980px; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 14px 0; }
    label { display:block; font-size: 12px; opacity: .75; margin-bottom: 6px; }
    input { padding: 10px; border: 1px solid #ccc; border-radius: 10px; min-width: 240px; }
    button { padding: 10px 12px; border: 1px solid #222; border-radius: 10px; background:#111; color:#fff; cursor:pointer; }
    button.secondary { background:#fff; color:#111; border-color:#ccc; }
    button.danger { background:#b00020; border-color:#b00020; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; vertical-align: top; }
    th { font-size: 12px; opacity: .7; }
    .muted { opacity:.7; font-size: 12px; }
    .pill { padding: 2px 8px; border-radius: 999px; font-size: 12px; border:1px solid #ddd; display:inline-block; }
    .ok { border-color:#2e7d32; color:#2e7d32; }
    .off { border-color:#b00020; color:#b00020; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .status { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
    .tokenBox { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; background:#f7f7f7; border:1px solid #eee; padding:8px; border-radius:10px; }
  </style>
</head>
<body>
  <h1>Store Admin (1 toko = 1 soundbox)</h1>
  <div class="muted">Base URL: <span id="baseUrlText"></span></div>

  <div class="card">
    <h3 style="margin-top:0">Login Admin</h3>
    <div class="row">
      <div>
        <label>ADMIN_KEY</label>
        <input id="adminKey" type="password" placeholder="Masukkan ADMIN_KEY" />
      </div>
      <button onclick="saveKey()">Simpan Key</button>
      <button class="secondary" onclick="clearKey()">Hapus Key</button>
      <button class="secondary" onclick="refresh()">Refresh List</button>
    </div>
    <div class="muted" style="margin-top:10px">
      Key disimpan di <b>sessionStorage</b> (hilang saat tab/browser ditutup).
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Tambah / Update Store (UPSERT)</h3>
    <div class="row">
      <div>
        <label>store_id (unik)</label>
        <input id="store_id" placeholder="toko-001" />
      </div>
      <div>
        <label>name</label>
        <input id="name" placeholder="Toko Ayam" />
      </div>
      <button onclick="upsertStore()">Simpan</button>
      <button class="secondary" onclick="generateToken()">Generate Token Baru</button>
    </div>
    <div class="muted" style="margin-top:10px">
      - Tombol <b>Simpan</b>: kalau store sudah ada â†’ update name dan token tetap (kecuali kamu isi token manual).<br/>
      - Tombol <b>Generate Token Baru</b>: buat token baru lalu auto upsert (buat kasus soundbox hilang / ganti unit).
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Stores</h3>
    <div class="actions" style="margin-bottom:10px">
      <button class="secondary" onclick="refresh()">Refresh</button>
    </div>
    <div id="tableWrap"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Log</h3>
    <div id="log" class="status"></div>
  </div>

<script>
  const BASE_URL = "https://server.soundboxqris123.workers.dev";
  document.getElementById("baseUrlText").textContent = BASE_URL;

  const logEl = document.getElementById("log");
  const adminKeyInput = document.getElementById("adminKey");

  function log(msg) {
    logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + logEl.textContent;
  }

  function getKey() {
    return sessionStorage.getItem("ADMIN_KEY") || "";
  }

  function saveKey() {
    const k = adminKeyInput.value.trim();
    if (!k) return alert("Masukkan ADMIN_KEY dulu");
    sessionStorage.setItem("ADMIN_KEY", k);
    adminKeyInput.value = "";
    log("ADMIN_KEY tersimpan di sessionStorage");
    refresh();
  }

  function clearKey() {
    sessionStorage.removeItem("ADMIN_KEY");
    log("ADMIN_KEY dihapus dari sessionStorage");
    renderTable([]);
  }

  async function adminFetch(path, opts = {}) {
    const k = getKey();
    if (!k) throw new Error("ADMIN_KEY belum diset (isi dulu di Login Admin)");

    const headers = Object.assign({ "x-admin-key": k }, opts.headers || {});
    const res = await fetch(BASE_URL + path, { ...opts, headers });
    const txt = await res.text();

    let data;
    try { data = JSON.parse(txt); } catch { data = txt; }

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${typeof data === "string" ? data : JSON.stringify(data)}`);
    }
    return data;
  }

  async function refresh() {
    try {
      log("GET /admin/stores ...");
      const data = await adminFetch("/admin/stores");
      renderTable(data.stores || []);
      log(`OK: loaded ${data.stores?.length || 0} stores`);
    } catch (e) {
      log(`ERR: ${e.message}`);
      alert(e.message);
    }
  }

  function getForm() {
    return {
      store_id: document.getElementById("store_id").value.trim(),
      name: document.getElementById("name").value.trim(),
    };
  }

  function setForm(store_id, name) {
    document.getElementById("store_id").value = store_id || "";
    document.getElementById("name").value = name || "";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  async function upsertStore(extra = {}) {
    const { store_id, name } = getForm();
    if (!store_id || !name) return alert("store_id dan name wajib diisi");

    try {
      log("POST /admin/stores (upsert) ...");
      const payload = { store_id, name, ...extra };
      const out = await adminFetch("/admin/stores", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      // tampilkan token hasil response (important untuk pairing soundbox)
      log(`OK: upsert ${store_id} | token=${out.device_token}`);
      await refresh();
      alert(`Store tersimpan.\n\nstore_id: ${out.store_id}\nname: ${out.name}\ndevice_token: ${out.device_token}\n\nSimpan token ini untuk soundbox.`);
    } catch (e) {
      log(`ERR: ${e.message}`);
      alert(e.message);
    }
  }

  // Generate token baru: pakai prefix sb_ + random
  function randomHex(len = 32) {
    const arr = new Uint8Array(len / 2);
    crypto.getRandomValues(arr);
    return [...arr].map(b => b.toString(16).padStart(2, "0")).join("");
  }

  async function generateToken() {
    const { store_id, name } = getForm();
    if (!store_id || !name) return alert("Isi store_id dan name dulu, baru generate token");

    const newToken = "sb_" + randomHex(32);
    await upsertStore({ device_token: newToken });
  }

  async function enableStore(store_id) {
    try {
      log(`POST /admin/stores/enable ${store_id} ...`);
      await adminFetch("/admin/stores/enable", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ store_id }),
      });
      log(`OK: enabled ${store_id}`);
      await refresh();
    } catch (e) {
      log(`ERR: ${e.message}`);
      alert(e.message);
    }
  }

  async function disableStore(store_id) {
    try {
      log(`POST /admin/stores/disable ${store_id} ...`);
      await adminFetch("/admin/stores/disable", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ store_id }),
      });
      log(`OK: disabled ${store_id}`);
      await refresh();
    } catch (e) {
      log(`ERR: ${e.message}`);
      alert(e.message);
    }
  }

  async function deleteStore(store_id) {
    if (!confirm(`Hapus store ${store_id}? (permanen)`)) return;
    try {
      log(`POST /admin/stores/delete ${store_id} ...`);
      await adminFetch("/admin/stores/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ store_id }),
      });
      log(`OK: deleted ${store_id}`);
      await refresh();
    } catch (e) {
      log(`ERR: ${e.message}`);
      alert(e.message);
    }
  }

  async function copy(text) {
    try {
      await navigator.clipboard.writeText(text);
      log("Copied to clipboard");
      alert("Copied!");
    } catch {
      alert("Gagal copy (browser tidak mengizinkan). Copy manual ya.");
    }
  }

  function renderTable(stores) {
    const wrap = document.getElementById("tableWrap");
    if (!stores.length) {
      wrap.innerHTML = `<div class="muted">Tidak ada store (atau belum login admin).</div>`;
      return;
    }

    const rows = stores.map(s => {
      const badge = s.enabled ? `<span class="pill ok">enabled</span>` : `<span class="pill off">disabled</span>`;
      const token = s.device_token || "";
      return `
        <tr>
          <td>
            <b>${escapeHtml(s.store_id)}</b>
            <div class="muted">${escapeHtml(s.created_at || "")}</div>
          </td>
          <td>${escapeHtml(s.name || "")}</td>
          <td>${badge}</td>
          <td>
            <div class="tokenBox">${escapeHtml(token)}</div>
            <div class="actions" style="margin-top:8px">
              <button class="secondary" onclick="copy('${escapeJs(token)}')">Copy Token</button>
            </div>
          </td>
          <td>
            <div class="actions">
              <button class="secondary" onclick="setForm('${escapeJs(s.store_id)}','${escapeJs(s.name)}')">Edit</button>
              ${s.enabled
                ? `<button class="secondary" onclick="disableStore('${escapeJs(s.store_id)}')">Disable</button>`
                : `<button class="secondary" onclick="enableStore('${escapeJs(s.store_id)}')">Enable</button>`
              }
              <button class="danger" onclick="deleteStore('${escapeJs(s.store_id)}')">Delete</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>store_id</th>
            <th>name</th>
            <th>status</th>
            <th>device_token (soundbox)</th>
            <th>actions</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function escapeJs(s) {
    return String(s).replace(/\\/g, "\\\\").replace(/'/g, "\\'");
  }
</script>
</body>
</html>
